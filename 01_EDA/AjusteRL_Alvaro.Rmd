---
title: "FAD_DataAnalysis_practica"
author: "Alvaro Simón Merino, Antonio Fernández Cáceres, Katsiaryna Zaitsava"
date: "12/12/2021"
output:
  html_document:
    theme: united
    code_folding: "hide"
    toc: yes
    toc_float: yes
  pdf_document: 
    theme: united
    code_folding: "hide"
    toc: yes
    toc_float: yes
---

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cargar librerias

```{r include=FALSE}
library(caret)
library(dplyr)
library(ggplot2)
library(stringr)
library(readr)
library(batman)
library(knitr)
library(tidyr)
library(glmnet)
```
<br/>

## 02 Cargo los datos ya limpios y procesados

```{r loadData}
data_train <- read.csv(file = '../01_EDA/data_train_clean.csv', header = TRUE)
set.seed(12345)
summary(data_train)
```
<br/>

## 03 Entrenamiento del modelo ML con todas las variables
**Entrenamiento del logaritmo con variable "price" sin transformar**
```{r model01}
lm_model_std = lm(price ~ neighbourhood_group_cleansed + latitude + longitude + property_type + room_type + accommodates + bedrooms + minimum_nights + availability_365 + review_scores_rating + reviews_per_month + host_exp_days + last_review_days, data=data_train)

summary(lm_model_std)

# Residuals normality
plot(lm_model_std, 1)

# Residuals qq plot
plot(lm_model_std, 2)
```

Se puede observar que en este caso al aplicar el precio sin la conversión logarítimica el gráfico Q-Q sobre los residuos no se acerca a una distribución normal. Por otro lado, el error R2 es de 0.42.

**Entrenamiento del logaritmo con variable "price" transformada mediante logaritmo**
```{r model02, message=FALSE, warning=FALSE}
price_trans <- log(data_train$price)
lm_model_log = lm(price_trans ~ neighbourhood_group_cleansed + latitude + longitude + property_type + room_type + accommodates + bedrooms + minimum_nights + availability_365 + review_scores_rating + reviews_per_month + host_exp_days + last_review_days, data=data_train)


summary(lm_model_log)

# Residuals normality
plot(lm_model_log, 1)

# Residuals qq plot
plot(lm_model_log, 2)

# Normality test
lillie.test(lm_model_log$residuals)
```

Podemos observar que tras entrenar el modelo LMR sobre la variable precio convertida mediante el logaritmo se obtiene una gráfica Q-Q con una distribución más ajustada a ser normal, a pesar de que tras el test de kolmogorov Smirnov no se acepta la normalidad. Además se puede observar que el error R2 aumenta a 0.60.
<br/>

### Selección de varibles mediante Lasso
```{r}
data_lasso <- data_train[,-1] 
lambdas <- model.matrix(price_trans~., data = data_lasso)
y <- data_train$price

# Funciones de error por variable
models_lasso <- glmnet(x = lambdas, y = y, alpha = 1)
plot(models_lasso, xvar = "lambda", label = TRUE)

set.seed(737)

# Ajuste de la función de error
cv_lasso <- cv.glmnet(x = lambdas, y = y, alpha = 1)
plot(cv_lasso)

# Registro resumen con variables seleccionadas por Lasso != 0
out_eleven <- glmnet(lambdas,y,alpha=1,lambda = cv_lasso$lambda.1se)
lasso_coef_eleven <- predict(out_eleven, type="coefficients")[1:21,]
lasso_coef_eleven
```
